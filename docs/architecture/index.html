<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Software Architecture | The Chorally Developers Handbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://omsoft.github.io/chorally-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://omsoft.github.io/chorally-docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://omsoft.github.io/chorally-docs/docs/architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Software Architecture | The Chorally Developers Handbook"><meta data-rh="true" name="description" content="Easy Chorally is a multi layer system where several microservices operate through synchronous restful APIs, async workers and realtime data pipelines to exchange data, consume events, and communicate with social media platforms."><meta data-rh="true" property="og:description" content="Easy Chorally is a multi layer system where several microservices operate through synchronous restful APIs, async workers and realtime data pipelines to exchange data, consume events, and communicate with social media platforms."><link data-rh="true" rel="icon" href="/chorally-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://omsoft.github.io/chorally-docs/docs/architecture"><link data-rh="true" rel="alternate" href="https://omsoft.github.io/chorally-docs/docs/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://omsoft.github.io/chorally-docs/docs/architecture" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Software Architecture","item":"https://omsoft.github.io/chorally-docs/docs/architecture"}]}</script><link rel="stylesheet" href="/chorally-docs/assets/css/styles.869cbad3.css">
<script src="/chorally-docs/assets/js/runtime~main.efc8ca65.js" defer="defer"></script>
<script src="/chorally-docs/assets/js/main.a142ae5e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/chorally-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/chorally-docs/"><div class="navbar__logo"><img src="/chorally-docs/img/logo.svg" alt="Chorally" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/chorally-docs/img/logo.svg" alt="Chorally" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Chorally Docs</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://gitlab.navarcos.ccoe-nc.com/chorally/easy-chorally/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitLab<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://chorally.atlassian.net/jira/software/projects/RCH/boards/58" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Jira RCH<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/chorally-docs/docs/intro"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/chorally-docs/docs/platform_overview"><span title="Chorally Overview" class="linkLabel_WmDU">Chorally Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/chorally-docs/docs/architecture"><span title="Software Architecture" class="linkLabel_WmDU">Software Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/chorally-docs/docs/workflows"><span title="Workflows" class="linkLabel_WmDU">Workflows</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/chorally-docs/docs/shared_libraries"><span title="Shared Libraries" class="linkLabel_WmDU">Shared Libraries</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/chorally-docs/docs/catalog/intro"><span title="catalog" class="categoryLinkLabel_W154">catalog</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/chorally-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Software Architecture</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Software Architecture</h1></header>
<p>Easy Chorally is a multi layer system where several microservices operate through synchronous restful APIs, async workers and realtime data pipelines to exchange data, consume events, and communicate with social media platforms.</p>
<p>This page describes the overall software architecture, and offer guidelines to setup a service from scratch.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="types-of-services">Types of Services<a href="#types-of-services" class="hash-link" aria-label="Direct link to Types of Services" title="Direct link to Types of Services" translate="no">​</a></h2>
<p>There are 30+ microservices in the network, but they can be categorized in 3 groups:</p>
<ul>
<li class=""><strong>I/O services</strong> are abstraction layers for social media platforms (Meta, Linkedin, Microsoft, Google, etc)<!-- -->
<ul>
<li class="">They pull contents such as comments or reviews</li>
<li class="">They push contents such as new posts or business replies</li>
<li class="">They handle OAuth flows and token renewals to keep channels active</li>
</ul>
</li>
<li class=""><strong>Ticket-related services</strong> manipulate informations that belong to a Ticket (eg. messages, logs, metadata)</li>
<li class=""><strong>Feature-specific services</strong> offer a specific functionality (eg. rules, chatbot, media upload, etc)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="clusters">Clusters<a href="#clusters" class="hash-link" aria-label="Direct link to Clusters" title="Direct link to Clusters" translate="no">​</a></h2>
<p>We run our systems in four main K8s clusters (environments):</p>
<ul>
<li class=""><strong>chorally-dev (dev)</strong>: represents the environment used by developers to build new functionalities</li>
<li class=""><strong>chorally-stage (stage)</strong>: it&#x27;s where members of QA/Product Team test new functionalities before release</li>
<li class=""><strong>chorally-prod (app)</strong>: production environment used by most of Chorally customers</li>
<li class=""><strong>aks-sogei (az)</strong>: custom production environment for Agenzia delle Entrate</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-flow--events">Data flow &amp; Events<a href="#data-flow--events" class="hash-link" aria-label="Direct link to Data flow &amp; Events" title="Direct link to Data flow &amp; Events" translate="no">​</a></h2>
<p>Here&#x27;s what happens behind the scenes for different scenarios...</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="incoming-messages">Incoming messages<a href="#incoming-messages" class="hash-link" aria-label="Direct link to Incoming messages" title="Direct link to Incoming messages" translate="no">​</a></h3>
<ol>
<li class=""><strong>I/O services</strong> pull data from social networks via webhooks or scheduled imports</li>
<li class="">New authors are sent to <strong>Author Service</strong> via Kafka on <code>authors</code> topic</li>
<li class="">New messages are sent to <strong>Message Service</strong> via Kafka on <code>messages</code> topic</li>
<li class=""><strong>Message Service</strong> organizes them in separate tickets (one for each author)</li>
<li class=""><strong>Log Service</strong> creates a log of what just happened and notifies the rules engine</li>
<li class=""><strong>Rules Engine</strong> executes rules that match with specified conditions</li>
<li class="">Agents can now see and reply to individual tickets from Chorally UI</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="outbound-contents">Outbound contents<a href="#outbound-contents" class="hash-link" aria-label="Direct link to Outbound contents" title="Direct link to Outbound contents" translate="no">​</a></h3>
<p><strong>Ticket Replies: when agents reply to a ticket...</strong></p>
<ol>
<li class="">The reply is sent to <strong>Message Service</strong> from Chorally UI</li>
<li class="">Message Service sends a Kafka event to the specific <strong>I/O channel</strong></li>
<li class=""><strong>I/O service</strong> calls external APIs to send the reply on the social network</li>
<li class="">The ID of the published reply is returned back with a &quot;reconciliation event&quot;</li>
</ol>
<p><strong>Publishing: when agents create new Page Posts...</strong></p>
<ol>
<li class="">Agents create drafts of new posts through <strong>Publishing Service</strong></li>
<li class="">Posts must be approved by agents with adeguate permissions</li>
<li class="">When approved, posts are sent to <strong>I/O services</strong> via Kafka</li>
<li class=""><strong>I/O services</strong> call external APIs to publish the content</li>
<li class="">The ID of the published content is returned back to Publishing Service with a &quot;reconciliation event&quot;</li>
</ol>
<p><strong>New Conversation: when agents wants to communicate 1on1 with a customer...</strong></p>
<ol>
<li class="">Agents create a new conversation through <strong>Outbound Service</strong></li>
<li class=""><strong>Outbound Service</strong> dispatches a Kafka event to the desired <strong>I/O channel</strong></li>
<li class=""><strong>I/O service</strong> calls external APIs to publish the content</li>
<li class="">The ID of the published content is returned back with a &quot;reconciliation event&quot;</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="domain-provisioning">Domain Provisioning<a href="#domain-provisioning" class="hash-link" aria-label="Direct link to Domain Provisioning" title="Direct link to Domain Provisioning" translate="no">​</a></h3>
<p>It&#x27;s possible to set up a new domain and enable a subset of functionalities to a specific customer via a step-by-step provisioning procedure. Here&#x27;s how:</p>
<ol>
<li class="">Go to console.ENV.chorally.com and login</li>
<li class="">Create a new instance with customer data and select or create a package (set of features and modules)</li>
<li class="">Click on create and wait for the procedure to complete</li>
</ol>
<p>This will trigger a sequence of events:</p>
<ul>
<li class=""><strong>Package Service</strong> will receive the web request with selected informations</li>
<li class="">A Kafka event is sent to <strong>Provision Service</strong> that will configure the network (K8s, S3, Keycloak)</li>
<li class="">An email with credentials is sent to each admin</li>
<li class="">The domain is now ready</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rules-execution">Rules Execution<a href="#rules-execution" class="hash-link" aria-label="Direct link to Rules Execution" title="Direct link to Rules Execution" translate="no">​</a></h3>
<p>Understanding how Rules work is very important since Chorally heavily relies on them. There are two different services:</p>
<ul>
<li class="">
<p><strong>Rule Service</strong>: sends automatic replies based on temporal conditions (working days, opening/closing hours, special festivities, etc). Every time a new message enters the system, Rule Service evaluate if an automatic reply must be sent... therefore speeding up the feedback loop to the customer when the business is temporarily closed and no agent can offer support.</p>
</li>
<li class="">
<p><strong>Rule Engine Service</strong>: leveraging Drools, a BRMS system, it facilitates writing rules in a format which is easy to understand and allows to run actions against tickets when a new message arrives.</p>
</li>
</ul>
<p>Both systems starts automatically whenever a new message arrives. I/O services will receive the message, send it via Kafka to Message Service, then Message Service will dispatch a log to Log Service, and Log Service sends a &quot;rule-trigger&quot; event to Rules Engine. This engine will fetch active rules from its database and check if they match with message properties. If they do, Drools runs the associated action (could be &quot;send message&quot;, &quot;set tag&quot;, or whatever action was configured).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="point-to-point-communication">Point-to-Point Communication<a href="#point-to-point-communication" class="hash-link" aria-label="Direct link to Point-to-Point Communication" title="Direct link to Point-to-Point Communication" translate="no">​</a></h2>
<p>Services share data in two ways:</p>
<ol>
<li class=""><strong>Kafka</strong>: event-driven asynchronous requests</li>
<li class=""><strong>REST APIs</strong>: synchronous data exchange</li>
</ol>
<p>In the next few lines you&#x27;ll learn how to engineer them appropriately.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="api-ingresses">API Ingresses<a href="#api-ingresses" class="hash-link" aria-label="Direct link to API Ingresses" title="Direct link to API Ingresses" translate="no">​</a></h3>
<p>Services in the network are accessible via a standard url structure: <strong><a href="https://api.ENV.chorally.com/SERVICE" target="_blank" rel="noopener noreferrer" class="">https://api.ENV.chorally.com/SERVICE</a></strong></p>
<p><em>[ENV is the environment, and SERVICE is the service as defined in the Kubernetes configuration]</em></p>
<p>This url is open to the public. So be aware of the risks when you add new endpoints or assets!</p>
<p>For example, if your service is called chatbot, you can access its APIs with: <a href="https://api.dev.chorally.com/chatbot/v1/add" target="_blank" rel="noopener noreferrer" class="">https://api.dev.chorally.com/chatbot/v1/add</a></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="api-authorization">API Authorization<a href="#api-authorization" class="hash-link" aria-label="Direct link to API Authorization" title="Direct link to API Authorization" translate="no">​</a></h3>
<p>Every single API entrypoint MUST be authorized and actions performed only if successful. The only exception is represented by Kafka consumers that receives realtime events from the broker (they do not require authorization).</p>
<p>There are two ways...</p>
<p>A <strong>JWT Signed Token</strong> issued by Keycloak is the preferred way to go (especially for requests that come from Chorally User Interface). A JWT contains relevant informations about the specific Tenant and User performing the action, and is subject to expiration allowing for a stronger identity management and detection. If you receive a JWT you must verify the signature against the Keycloak SSL certificates before authorizing the request.</p>
<p>Alternatively, you can use a <strong>custom Secret Token</strong>. A token only you (the receiver) and the other service (the sender) are aware of. This token can be easily stored in environment variables within the cluster, and rotated for security reasons every once in a while.</p>
<p>Here&#x27;s an example of both:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># JWT Signed Token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Bearer [jwt_token]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Secret Token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Token [secret_token].[tenant]</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="kafka-events">Kafka Events<a href="#kafka-events" class="hash-link" aria-label="Direct link to Kafka Events" title="Direct link to Kafka Events" translate="no">​</a></h3>
<p>All Kafka events shared in the network MUST follow this simple structure:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  issuer</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;message-service&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// name of service sending it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;add&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                          </span><span class="token comment" style="color:#999988;font-style:italic">// event name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">                                </span><span class="token comment" style="color:#999988;font-style:italic">// object with custom properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hey, can you help me?&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    external_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1234567&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    received_at</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2025-11-14T18:30:00Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The TOPIC must be chosen appropriately. Its name represents the entity being sent.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="reserved-topics">Reserved Topics<a href="#reserved-topics" class="hash-link" aria-label="Direct link to Reserved Topics" title="Direct link to Reserved Topics" translate="no">​</a></h4>
<p>We have a bunch of reserved topics:</p>
<ul>
<li class=""><strong>messages</strong>: used by message-service for add/update/delete events</li>
<li class=""><strong>tickets</strong>: used by message-service to update ticket properties</li>
<li class=""><strong>logs</strong>: used by log-service</li>
<li class=""><strong>authors</strong>: used by author-service</li>
<li class=""><strong>rule-triggers</strong>: used by rules-engine to trigger rules evaluation</li>
<li class=""><strong>queue-triggers</strong>: used by rules-engine to trigger rules evaluation</li>
</ul>
<p><strong>Each I/O service has its own topic</strong> used for agent replies or other updates that must be sent to the social network (eg. trustpilot_review, facebook_comment, etc)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="redis">Redis<a href="#redis" class="hash-link" aria-label="Direct link to Redis" title="Direct link to Redis" translate="no">​</a></h2>
<p>The purpose of this section is to provide a top-level overview of how Redis is used, how it affects the whole ecosystem and what to do when Redis connection is unavailable. At the end, I describe a few solutions to avoid bottlenecks and system disruptions.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-redis-is-used-for">What Redis Is Used For<a href="#what-redis-is-used-for" class="hash-link" aria-label="Direct link to What Redis Is Used For" title="Direct link to What Redis Is Used For" translate="no">​</a></h3>
<p>Redis is a hard dependency of some internal functionalities of Easy-Chorally:</p>
<ul>
<li class="">
<p><strong>Searchkick</strong> is used for data indexing and stem queries; every time a record is
saved, updated or destroyed, the application will push or pull a job to Redis and
provide a highly efficient querying interface of tickets, messages, tags;</p>
<ul>
<li class="">used by message, author, search, and metadata services</li>
</ul>
</li>
<li class="">
<p><strong>Sidekiq</strong> provides a scalable and efficient thread-based background processing
system and we’re using it to handle incoming messages (comments from social
media), outbound messages (replies from operators), data exporting and so on,
to offer low latency responses to all public APIs without blocking RTTs in the
browser so users won’t wait for the results;</p>
<ul>
<li class="">used by most ruby apps to push/pull jobs from a set of Redis queues</li>
</ul>
</li>
</ul>
<p><strong>The connection to Redis is forced at startup</strong> and depends on a sentinel that will
automatically return the IP address to a master node, ensuring read/write capabilities.</p>
<p>From a container perspective Redis is used everywhere where:</p>
<table><thead><tr><th>Container</th><th>Uses Redis?</th><th>Purpose</th></tr></thead><tbody><tr><td>Puma (api)</td><td>Yes</td><td>It’s a Searchkick dependency, but may be used also for caching, sessions, rate limiting, in-memory processing</td></tr><tr><td>Sidekiq</td><td>Yes</td><td>Job queue and inter-process communication</td></tr><tr><td>Karafka (Consumer)</td><td>Yes</td><td>It’s a Searchkick dependency, but may be used also for caching, sessions, rate limiting, in-memory processing</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-happens-when-redis-is-down">What Happens When Redis Is Down<a href="#what-happens-when-redis-is-down" class="hash-link" aria-label="Direct link to What Happens When Redis Is Down" title="Direct link to What Happens When Redis Is Down" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-sidekiq">1. Sidekiq<a href="#1-sidekiq" class="hash-link" aria-label="Direct link to 1. Sidekiq" title="Direct link to 1. Sidekiq" translate="no">​</a></h4>
<ul>
<li class="">
<p><strong>Startup</strong>: At startup the application <strong>immediately tries to connect to Redis</strong> to fetch job queues. If Redis is unavailable, Sidekiq will:</p>
<ul>
<li class="">Retry the connection a few times.</li>
<li class="">Then crash with a Redis::CannotConnectError or similar.</li>
</ul>
</li>
<li class="">
<p><strong>Runtime</strong>:</p>
<ul>
<li class="">If Redis becomes unavailable <strong>after startup</strong>, jobs stop processing.</li>
<li class="">Sidekiq will log repeated “Redis connection error” messages, and may
eventually exit.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-puma-api-container">2. Puma (API container)<a href="#2-puma-api-container" class="hash-link" aria-label="Direct link to 2. Puma (API container)" title="Direct link to 2. Puma (API container)" translate="no">​</a></h4>
<ul>
<li class="">
<p><strong>Startup</strong>: a Redis client is instantiated at boot.</p>
<ul>
<li class="">If Redis is <strong>unavailable</strong> the container may fail to boot</li>
</ul>
</li>
<li class="">
<p><strong>Runtime</strong>:</p>
<ul>
<li class="">If Redis becomes unavailable after startup, Puma will continue to work and APIs will be available but <strong>specific endpoints may raise Redis::CannotConnectError</strong> until Redis returns back on (especially endpoints with any Searchkick query or background job scheduling)</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-karafka-consumer-container">3. Karafka (consumer container)<a href="#3-karafka-consumer-container" class="hash-link" aria-label="Direct link to 3. Karafka (consumer container)" title="Direct link to 3. Karafka (consumer container)" translate="no">​</a></h4>
<ul>
<li class="">
<p><strong>Startup</strong>: a Redis client is instantiated at boot.</p>
<ul>
<li class="">If Redis is <strong>unavailable</strong> the container may fail to boot</li>
</ul>
</li>
<li class="">
<p><strong>Runtime</strong>:</p>
<ul>
<li class="">If Redis becomes unavailable after startup, processing kafka messages may fail and they will be retried or delayed.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-to-do-after-redis-connection-has-been-fixed">What to do AFTER Redis Connection has been fixed<a href="#what-to-do-after-redis-connection-has-been-fixed" class="hash-link" aria-label="Direct link to What to do AFTER Redis Connection has been fixed" title="Direct link to What to do AFTER Redis Connection has been fixed" translate="no">​</a></h3>
<p>The quick and easy way to restore connections is to <strong>reboot all containers</strong>.</p>
<p>They will automatically reconnect at startup as described above.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="solutions--mitigations-to-redis-outages">Solutions / Mitigations to Redis outages<a href="#solutions--mitigations-to-redis-outages" class="hash-link" aria-label="Direct link to Solutions / Mitigations to Redis outages" title="Direct link to Solutions / Mitigations to Redis outages" translate="no">​</a></h3>
<p>When Redis becomes unavailable there might be unintended consequences, and services that heavily depend on it will stop working as expected. Here are a few possible solutions to prevent bottlenecks that we can implement into the architecture:</p>
<ul>
<li class="">Lazy Redis connection: avoid connecting to Redis at boot and print a warning
message if Redis is unavailable.<!-- -->
<ul>
<li class="">Pros: Useful to prevent blocking container the startup</li>
<li class="">Cons: functionalities still won’t work as expected</li>
</ul>
</li>
<li class="">Disable Searchkick async callbacks when Redis isn’t available<!-- -->
<ul>
<li class="">Pros: read-only operation will work even when Redis is down</li>
<li class="">Cons: indexing will perform synchronously and APIs will take longer to complete RTT</li>
</ul>
</li>
<li class="">Add retry/wait logic at container startup<!-- -->
<ul>
<li class="">Pros: container will eventually startup as soon as Redis becomes available</li>
<li class="">Cons: container will wait until Redis is actually available</li>
</ul>
</li>
<li class="">Circuit breaker: catch RedisConnectionError at runtime everywhere there’s a business critical task, log an error instead of crashing, and retry the process (where possible)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="tecnologies">Tecnologies<a href="#tecnologies" class="hash-link" aria-label="Direct link to Tecnologies" title="Direct link to Tecnologies" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="languages--frameworks">Languages &amp; Frameworks<a href="#languages--frameworks" class="hash-link" aria-label="Direct link to Languages &amp; Frameworks" title="Direct link to Languages &amp; Frameworks" translate="no">​</a></h3>
<ul>
<li class=""><strong>Ruby with Grape</strong></li>
<li class=""><strong>Go</strong></li>
<li class=""><strong>Java/Spring Boot</strong></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="database">Database<a href="#database" class="hash-link" aria-label="Direct link to Database" title="Direct link to Database" translate="no">​</a></h3>
<ul>
<li class=""><strong>MongoDB</strong> (main choice)</li>
<li class=""><strong>MySQL</strong> (will be migrated to Mongo)</li>
<li class=""><strong>Redis</strong> (as in-memory cache storage)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hard-dependencies">Hard dependencies<a href="#hard-dependencies" class="hash-link" aria-label="Direct link to Hard dependencies" title="Direct link to Hard dependencies" translate="no">​</a></h3>
<p>The system is integrated with the following components and cannot operate without them:</p>
<ul>
<li class=""><strong>Keycloak</strong>: Identity Server used for authentication and authorization of web requests</li>
<li class=""><strong>Kafka</strong>: Realtime messaging for async communications among microservices</li>
<li class=""><strong>S3 Storage</strong>: Storage system with isolated buckets for objects and media</li>
<li class=""><strong>Mongo</strong>: Database engine used my most microservices in the network</li>
<li class=""><strong>Redis</strong>: In-memory data store for low latency data manipulation</li>
<li class=""><strong>OpenSearch</strong>: Distributed search engine that store data and process search requests.</li>
<li class=""><strong>Kubernetes</strong>: Container orchestration platform that manages clusters, load balancing, and configuration</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment" translate="no">​</a></h2>
<p>All microservices are designed to be distributed as Docker containers within Kubernetes clusters, and configured with environment variables.</p>
<hr>
<p><em>Latest update: 2025-11-14</em></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/chorally-docs/docs/platform_overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chorally Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/chorally-docs/docs/workflows"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Workflows</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#types-of-services" class="table-of-contents__link toc-highlight">Types of Services</a></li><li><a href="#clusters" class="table-of-contents__link toc-highlight">Clusters</a></li><li><a href="#data-flow--events" class="table-of-contents__link toc-highlight">Data flow &amp; Events</a><ul><li><a href="#incoming-messages" class="table-of-contents__link toc-highlight">Incoming messages</a></li><li><a href="#outbound-contents" class="table-of-contents__link toc-highlight">Outbound contents</a></li><li><a href="#domain-provisioning" class="table-of-contents__link toc-highlight">Domain Provisioning</a></li><li><a href="#rules-execution" class="table-of-contents__link toc-highlight">Rules Execution</a></li></ul></li><li><a href="#point-to-point-communication" class="table-of-contents__link toc-highlight">Point-to-Point Communication</a><ul><li><a href="#api-ingresses" class="table-of-contents__link toc-highlight">API Ingresses</a></li><li><a href="#api-authorization" class="table-of-contents__link toc-highlight">API Authorization</a></li><li><a href="#kafka-events" class="table-of-contents__link toc-highlight">Kafka Events</a></li></ul></li><li><a href="#redis" class="table-of-contents__link toc-highlight">Redis</a><ul><li><a href="#what-redis-is-used-for" class="table-of-contents__link toc-highlight">What Redis Is Used For</a></li><li><a href="#what-happens-when-redis-is-down" class="table-of-contents__link toc-highlight">What Happens When Redis Is Down</a></li><li><a href="#what-to-do-after-redis-connection-has-been-fixed" class="table-of-contents__link toc-highlight">What to do AFTER Redis Connection has been fixed</a></li><li><a href="#solutions--mitigations-to-redis-outages" class="table-of-contents__link toc-highlight">Solutions / Mitigations to Redis outages</a></li></ul></li><li><a href="#tecnologies" class="table-of-contents__link toc-highlight">Tecnologies</a><ul><li><a href="#languages--frameworks" class="table-of-contents__link toc-highlight">Languages &amp; Frameworks</a></li><li><a href="#database" class="table-of-contents__link toc-highlight">Database</a></li><li><a href="#hard-dependencies" class="table-of-contents__link toc-highlight">Hard dependencies</a></li></ul></li><li><a href="#deployment" class="table-of-contents__link toc-highlight">Deployment</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/chorally-docs/docs/intro">Intro</a></li><li class="footer__item"><a class="footer__link-item" href="/chorally-docs/docs/architecture">Architecture</a></li><li class="footer__item"><a class="footer__link-item" href="/chorally-docs/docs/workflows">Workflows</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chorally.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://tr-react.activadigital.it/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TimeVision<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chorally.atlassian.net/jira/software/projects/RCH/boards/58" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jira RCH Board<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://gitlab.navarcos.ccoe-nc.com/chorally/easy-chorally/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitLab<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Chorally. Built by the engineering team with Docusaurus.</div></div></div></footer></div>
</body>
</html>